import {ArgsTable, Canvas, Meta, Props, Story} from '@storybook/addon-docs';
import {MemoryRouter} from 'react-router-dom';

import {SUBMISSION_ALLOWED} from 'components/constants';
import {RouterDecorator} from 'story-utils/decorators';

import ProgressIndicator from '.';
import ProgressIndicatorDisplay from './ProgressIndicatorDisplay';

<Meta
  title="Composites/ProgressIndicator"
  component={ProgressIndicator}
  argTypes={{
    submissionAllowed: {
      options: Object.values(SUBMISSION_ALLOWED),
      control: {type: 'radio'},
    },
    'submission.submissionAllowed': {
      options: Object.values(SUBMISSION_ALLOWED),
      control: {type: 'radio'},
    },
    submission: {table: {disable: true}},
  }}
/>

# ProgressIndicator

The progress indicator displays the progression through a particular form's steps.

## Presentation

The `ProgressIndicatorDisplay` component shows the different steps in a form. The style of each step
varies depending on whether it is applicable, it is completed or it is the currently active step.

export const DisplayTemplate = args => <ProgressIndicatorDisplay {...args} />;

<Canvas>
  <Story
    name="Display"
    decorators={[RouterDecorator]}
    args={{
      activeStepTitle: 'Stap 2',
      formTitle: 'Storybookformulier',
      steps: [
        {
          uuid: '111',
          slug: 'stap1',
          formDefinition: 'Stap 1',
          isCompleted: true,
          isApplicable: true,
          isCurrent: false,
          canNavigateTo: true,
        },
        {
          uuid: '222',
          slug: 'stap2',
          formDefinition: 'Stap 2',
          isCompleted: false,
          isApplicable: true,
          isCurrent: true,
          canNavigateTo: true,
        },
        {
          uuid: '333',
          slug: 'stap3',
          formDefinition: 'Stap 3',
          isCompleted: false,
          isApplicable: false,
          isCurrent: false,
          canNavigateTo: false,
        },
      ],
      hasSubmission: true,
      isStartPage: false,
      isSummary: false,
      isConfirmation: false,
      isSubmissionComplete: false,
      areApplicableStepsCompleted: false,
      showOverview: true,
      showConfirmation: false,
    }}
  >
    {DisplayTemplate.bind({})}
  </Story>
</Canvas>

### Props

<ArgsTable of={ProgressIndicatorDisplay} />

## Functional

The `ProgressIndicator` component handles the 'smart' behaviour. It checks:

- If the steps are currently active, completed, applicable or if a step can be clicked to navigate
  to it.
- If the current page is the start page, the summary page or the confirmation page.
- If all the applicable steps have been completed.

It is responsible for rendering the `ProgressIndicatorDisplay` component.

The current step is detected through the URL route match, based on the `slug` of an individual step.
The complete collection of available form steps is loaded when the form is initially loaded, and
passed as prop through the component.

Note that a particular step may become not-applicable while filling out the form because of certain
logic rules. The details of each step's status are available in `submission.steps[@index]`.

export const Template = ({steps, completedSteps, applicableSteps, ...args}) => {
  const submission = {
    id: 'ddfede40-99af-424c-97d1-d2c64e744a09',
    url: 'https://backend/api/v1/submissions/ddfede40-99af-424c-97d1-d2c64e744a09',
    form: 'https://backend/api/v1/forms/9d49e773',
    submissionAllowed: args['submission.submissionAllowed'],
    steps: steps.map((formStep, index) => ({
      isApplicable: applicableSteps.includes(index),
      completed: completedSteps.includes(index),
    })),
    payment: {
      isRequired: false,
      hasPaid: false,
    },
  };
  let currentUrl = '/';
  if (completedSteps.length) {
    const index = completedSteps[completedSteps.length - 1];
    currentUrl = `/stap/${steps[index].slug}`;
  }
  return (
    <MemoryRouter initialEntries={[currentUrl]}>
      <ProgressIndicator
        title={args.title}
        submission={args.submission === null ? null : submission}
        steps={steps}
        submissionAllowed={args.submissionAllowed}
        completed={args.completed}
      />
    </MemoryRouter>
  );
};

<Canvas>
  <Story
    name="Active submission"
    args={{
      // story args
      steps: [
        {
          url: 'https://backend/api/v1/form/9d49e773/steps/d6cab0dd',
          uuid: 'd6cab0dd',
          index: 0,
          slug: 'first-step',
          formDefinition: 'Stap 1',
        },
        {
          url: 'https://backend/api/v1/form/9d49e773/steps/8e62d7cf',
          uuid: '8e62d7cf',
          index: 1,
          slug: 'second-step',
          formDefinition: 'Stap 2',
        },
      ],
      completedSteps: [0],
      applicableSteps: [0],
      'submission.submissionAllowed': 'yes',
      // component props
      title: 'Storybookformulier',
      submissionAllowed: 'yes',
      completed: false,
    }}
    argTypes={{
      submissionAllowed: {table: {disable: true}},
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

## Form start

On initial load, no submission is available yet.

<Canvas>
  <Story
    name="Initial form load"
    args={{
      // story args
      steps: [
        {
          url: 'https://backend/api/v1/form/9d49e773/steps/d6cab0dd',
          uuid: 'd6cab0dd',
          index: 0,
          slug: 'first-step',
          formDefinition: 'Stap 1',
        },
        {
          url: 'https://backend/api/v1/form/9d49e773/steps/8e62d7cf',
          uuid: '8e62d7cf',
          index: 1,
          slug: 'second-step',
          formDefinition: 'Stap 2',
        },
      ],
      completedSteps: [],
      applicableSteps: [0, 1],
      'submission.submissionAllowed': 'yes',
      // component props
      title: 'Initial load',
      submissionAllowed: 'yes',
      completed: false,
      submission: null,
    }}
    argTypes={{
      'submission.submissionAllowed': {table: {disable: true}},
      completedSteps: {table: {disable: true}},
      applicableSteps: {table: {disable: true}},
      completed: {table: {disable: true}},
    }}
  >
    {Template.bind({})}
  </Story>
</Canvas>

## Props

<Props of={ProgressIndicator} />
